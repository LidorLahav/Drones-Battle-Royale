<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/html40/loose.dtd">
<html>
  <head>
    <meta name="author" content="shimony">
    <meta name="keywords" content="assignment 3">
    <meta name="description" content="Computer Architecture and system programming laboratory - 2020/Spring">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
    <link rel="stylesheet" type="text/css" href="css/style-global.css">
    <link rel="stylesheet" type="text/css" href="css/style-structure.css">
    <link rel="stylesheet" type="text/css" href="css/style-print.css" media="print">
    <link rel="stylesheet" type="text/css" href="css/blue-main.css">
    <link rel="shortcut icon" href="/~lab/course.wiki/images/flavicon.gif">
    <link rel="search" type="application/opensearchdescription+xml" title="Computer Architecture and system programming laboratory - 2020/Spring" href="http://www.cs.bgu.ac.il/~caspl202/Search?action=opensearch.xml">
        <title>Computer Architecture and system programming laboratory - 2020/Spring - Assignments / Assignment 3</title>

<!-- Accessibility - cs.bgu.ac.il. Added by Liat Dukhan 20_8_2018 for Nagish Be Click-->
<script data-cfasync="false"> 
	window.interdeal = {
		sitekey   : "b5bc2828e81e37d108096d991ba61619",
		Position  : "Left",
		Menulang  : "EN",
	}
</script>
<script src="js/js.nagich.co.il-accessibility.js" async data-cfasync="false"></script>

<script type="text/javascript" src="js/scripts-jquery.js"></script> 
<script type="text/javascript" src="js/scripts-jquery.cswiki.js"></script> 
<script type="text/javascript">
function win(u,n,w,h){
  if(n == '') n='Small_Window_'+Math.ceil((Math.random()*100000));
  window.open(u,n,'width='+w+',height='+h+',status=yes,resizable=yes,scrollbars=yes');
}

function ajax_request(action,params,cont,type){
  if(!type) type = 'json';
  $.ajaxSetup({ async:true,
                error: function (XMLHttpRequest, textStatus, errorThrown) { alert(textStatus);}});
  params.action = action;
  params.format = 'ajax';
  $.post('/~caspl202/index.php', params , cont, type);
}

// JQuery things
$(document).ready(function(){
  $.ImagesBase = "/~lab/course.wiki/images/";
  $('div.code,pre.code[filename!=]').code({ base: "/~caspl202/index.php" , imagesBase: $.ImagesBase});
  $('ul.collapsible').collapsible();
});
</script> 
<script type="text/javascript" src="js/latest-MathJax.js">
</script>
<script type="text/javascript">
MathJax.Hub.Config({
    extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax:
    {
        inlineMath: [["$","$"], ["\\(","\\)"]],
        ignoreClass: ".*",
        processClass: "__mathjax"
    },
    "HTML-CSS": { webFont: null }
  });
</script> 
  </head>
<body style="margin: 35px">

<div id="header">
<form action="/~caspl202/index.php" method="post" class="main-search" id="search-form">
<input type="hidden" name="page" value="Search">
<a href="Search.html">Search</a>  
<input type="text" name="q" value="">
<input type="submit" value="Go">
</form>
<div class="title"><a href="index.html">Computer Architecture and system programming laboratory - 2020/Spring</a></div>
</div>

<div id="container">

<div id="left-sidebar">
  <ul>
<li> <a href="Main.html">Main</a></li><li> <a href="arch_syl.html"> Syllabus</a>
</li><li> <a href="CourseInfo.html">Course info</a>: <a href="20212091.html">Arch&amp;SPlab</a>,
<a href="20212071.html">Splab</a>, <a href="20213041.html">Arch only</a>.
</li><li> <a href="Announcements.html">Announcements</a></li><li> <a href="Assignments.html">Assignments</a></li><li> <a href="Class_Material.html">Class material</a></li><li> <a href="Practical_Sessions.html">Practical sessions</a></li><li> <a href="Lab_Sessions.html">Lab sessions</a></li><li> <a href="Lab_Completions.html">Lab Completions</a></li><li> <a href="Previous_Exams.html">Previous exams</a></li><li> <a href="Useful_Links.html">Useful links</a></li><li> <a href="Forum.html">Forum</a></li><li> <a href="Labs_Forum.html">Labs Forum</a></li><li> <a href="Administrative_Q_And_A.html">Administrative Q&amp;A</a></li><li> <a href="http://cs-serv.cs.bgu.ac.il/cs_service/subsys.html" class="external" rel="nofollow">Submission system</a>
</li></ul>
    <br>
  
    <ul>
      <li><a href="RecentChanges.html">recent changes</a></li>
      <li><a href="Login?return=Assignments.html">login</a></li>
    </ul>
  
  
</div>

<div id="center-container">
    
<div id="navigate-bar">
  <div class="actions">
  <a href="Assignment_3?format=standalone.html" rel="nofollow">printable version</a>  </div>
  • <a href="Assignments.html">Assignments</a> » <a href="Assignment_3.html">Assignment 3</a></div>

<div id="main">
<div class="info" style="display:none" id="message-info"></div>
<div class="warning" style="display:none" id="message-error"></div>


<table class="toc"><tr><td id="showtoc5ee2030c82de6" style="display:none"><b>Contents</b> (<a onclick="document.getElementById('toc5ee2030c82de6').style.display='';document.getElementById('showtoc5ee2030c82de6').style.display='none'" href="Assignments.html">show</a>)</td></tr><tr id="toc5ee2030c82de6"><td><b>Contents</b> (<a onclick="document.getElementById('toc5ee2030c82de6').style.display='none';document.getElementById('showtoc5ee2030c82de6').style.display=''" href="Assignments.html">hide</a>)<br><div style="margin-left: 8px">1 <a href="#assignment_description">Assignment Description</a></div>
<div style="margin-left: 8px">2 <a href="#program_goal">Program Goal</a></div>
<div style="margin-left: 12px">2.1 <a href="#drones_battle_royale">Drones Battle Royale</a></div>
<div style="margin-left: 8px">3 <a href="#how_to_generate_a_pseudo-random_number">How to generate a pseudo-random number</a></div>
<div style="margin-left: 8px">4 <a href="#where_we_use_threads_in_the_game">Where we use Threads in the game</a></div>
<div style="margin-left: 8px">5 <a href="#command_line_arguments">Command line arguments</a></div>
<div style="margin-left: 8px">6 <a href="#initial_configuration_of_the_game">Initial configuration of the game</a></div>
<div style="margin-left: 8px">7 <a href="#how_to_print_the_game_board">How to print the game board</a></div>
<div style="margin-left: 8px">8 <a href="#important_implementation_requirements">Important implementation requirements</a></div>
<div style="margin-left: 8px">9 <a href="#submission_instructions">Submission Instructions</a></div>
</td></tr></table><h1>Assignment 3: multi-threading in assembly</h1>
<h2 id="assignment_description">Assignment Description</h2>
Your code will be written <b>entirely in assembly language</b>.
No C code is allowed, and no usage of C standard library functions other than those specifically noted below. The only C standard library code allowed is the initialization code at "_start" which calls main( ), usage of printf and fprintf functions to print floating point numbers and integers (and whatever else you need to print), and sscanf in order to convert the command line arguments. Use of malloc( ), calloc( ) and free( ) is also allowed, to handle your dynamic memory allocation.
<p>
You are to write a simple user-mode co-routine ("multi-thread") simulation, using the co-routine mechanism code described and provided in class. The goal is further proficiency in assembly language, especially as related to floating point, and understanding stack manipulations, as needed to create a co-routine (equivalently thread) management scheme. 
</p><h2 id="program_goal">Program Goal</h2>
<h3 id="drones_battle_royale">Drones Battle Royale</h3>
You will implement a multi-drones single-target game. 
<p>
We have a 100x100 game board, on which a group of N drones hunt the same target from different points of view and from different distances. Each drone tries to detect where is the target on the game board, in order to destroy it. Drones may destroy the target only if the target is no more than some given distance from the drone. When the current target is destroyed, some new target appears on the game board in some randomly chosen place. Every R rounds one of the drones is "eliminated" (in a manner which is described below), the last drone left in the game is the winner of the game.
</p><p>
Each drone has a two-dimensional position on the game board: (coordinate x, coordinate y), and direction (angle from x-axis)*, two drones may occupy the same position. Moreover each drone has a current speed which is increased or decreased in each round. All the above state variables are represented by floating point numbers. Drones move according to their speed using their curret heading,
from their current place. They then randomly change their speed and heading, as described below, before the next move. After each movement,  a drone calls the <b>mayDestroy(…)</b> function with its new position on the board. The <b>mayDestroy(…)</b> function returns TRUE if the caller drone may destroy the target, otherwise returns FALSE. If the current target is destroyed, a new target is created at a random position on the game board. Note that drones do not know the coordinates of the target on the board game. On the example below, the blue and the yellow drones are very far from the target and cannot destroy it, and the pink drone is close enough to it. The pink drone can destroy the target.
</p><p>
*<span style="font-size:85%">these coordinates are represented using floating point numbers. two drones are allowed to have the same coordinates</span>
</p><p>
<u>Please note</u>: the target is just a point, not a circle as it appears in the figures. The painting of a circle is just for the convenience of illustration. Also note that drones are illustrated as airplanes but they do not have all the appropriate functionality of airplanes.
</p><p>
<img src="images/assign3-ass3_fig1.jpeg" alt="assign3/ass3_fig1.jpeg" title="assign3/ass3_fig1.jpeg"></p><p>
When a drone moves from its current position to a new position, it may happen that the distance move makes the drone cross the 
game field border. We treat drone motion as if on a torus. That is, when the next location is greater than
the board width or height, or is negative in either axis (this requires checking 4 conditions), subtract or add the torus cycle (100 in this example) if needed. On the first figure below, we see a simple movement of the drone, and on the second figure we may see the movement that would move the drone out of the right border, and instead it is <b>wrapped around</b> to the left border of the game board. Speed may also change beyond the bounds (0 to 100), in this case we <b>clamp</b> (cut off) the value to
the repective bound, such as: having current speed 96.4 and increase by 6.5 makes the new speed 100. 
</p><p>
<img src="images/assign3-ass3_fig2.jpeg" alt="assign3/ass3_fig2.jpeg" title="assign3/ass3_fig2.jpeg"><img src="images/assign3-ass3_fig3.jpeg" alt="assign3/ass3_fig3.jpeg" title="assign3/ass3_fig3.jpeg"></p><h2 id="how_to_generate_a_pseudo-random_number">How to generate a pseudo-random number</h2>
You should use <a href="https://en.wikipedia.org/wiki/Linear-feedback_shift_register" class="external" rel="nofollow">Linear-feedback Shift Register method</a>  to get a random number in Assembly. A l<b>inear-feedback shift register (LFSR)</b> is a <a href="https://en.wikipedia.org/wiki/Shift_register" class="external" rel="nofollow">shift register</a> whose input bit is a linear function of its previous state. LFSR is a shift register whose input bit is driven by the XOR of some bits of the overall shift register value. The initial value of the LFSR is called the seed, and because the operation of the register is deterministic, the stream of values produced by the register is completely determined by its current (or previous) state. We would use Fibonacci LFSR version. 
The figure below describes a 16-bit Fibonacci LFSR. The feedback tap numbers shown correspond to a primitive polynomial in the table, so the register cycles through the maximum number of 65535 states excluding the all-zeroes state. The state shown, 0xACE1 will be followed by 0x5670.
<p>
<img src="images/assign3-ass3_fig8.png" alt="assign3/ass3_fig8.png" title="assign3/ass3_fig8.png"></p><p>
The bit positions that affect the next state are called the taps. In the diagram the taps are [16,14,13,11]. The rightmost bit of the LFSR is called the output bit. The taps are XOR'd sequentially with the output bit and then fed back into the leftmost bit. The sequence of bits in the rightmost position is called the output stream. The bits in the LFSR state that influence the input are called taps.
</p><p>
Note that the XOR function is as follows:
</p><p>
<img src="images/assign3-ass3_fig9.png" alt="assign3/ass3_fig9.png" title="assign3/ass3_fig9.png"></p><p>
<u>scaling process of random number:</u>
</p><ul>
<li> suppose you generated integer random number x in unsigned range [0,MAXINT]
</li><li> suppose you need to scale this number to your [0,100] board size to calculate some coordinate
</li><li> then, just execute the following calculation:
x_scaled = float point value of (x / MAXINT) * 100
</li></ul>
<h2 id="where_we_use_threads_in_the_game">Where we use Threads in the game</h2>
The drones and target are managed by threads, <b>one thread each</b>. We call thread a cooperating routine, or co-routine for short. In addition, we have a co-routine for the scheduler that manages when to run the other threads. A specialized co-routine called the printer prints the current state of the game board. A drone’s co-routine number is its id, which should be
visible to it as an argument at activation (either in a register, or on its own stack, your choice). 
We use drone’s id for scheduling and for printing.
The program begins by creating the initial state configuration of drones and the initial state of the target. The program initializes appropriate drones and target, and control is then passed to a scheduler co-routine which decides the appropriate scheduling for the co-routines. The scheduling algorithm for drones is ROUND ROBIN, meaning that co-routines are scheduled in a loop: 1,2,3,,N,1,2,3,N, and so on. The printer co-routine should print the current state of the game board each K steps, where step means an execution step of one drone.
<p>
<b>The function of a drone co-routine is as follows:</b>
</p><pre class="code">
(*) Generate random heading change angle  ∆α       ; generate a random number in range [-60,60] degrees, with 16 bit resolution
(*) Generate random speed change ∆a         ; generate random number in range [-10,10], with 16 bit resolution        
(*) Compute a new drone position as follows:
    (*) first move speed units at the direction defined by the current angle, wrapping around the torus if needed.
        For example, if speed=60 then move 60 units in the current direction.
    (*) then change the current angle to be α + ∆α, keeping the angle between [0, 360] by wraparound if needed
    (*) then change the current speed to be speed + ∆a, keeping the speed between [0, 100] by cutoff if needed
(*) Do forever
    (*) if mayDestroy(…) (check if a drone may destroy the target)
        (*) destroy the target	
        (*) resume target co-routine
    (*) Generate random angle ∆α       ; generate a random number in range [-60,60] degrees, with 16 bit resolution
    (*) Generate random speed change ∆a    ; generate random number in range [-10,10], with 16 bit resolution        
    (*) Compute a new drone position as follows:
        (*) first, move speed units at the direction defined by the current angle, wrapping around the torus if needed. 
        (*) then change the new current angle to be α + ∆α, keeping the angle between [0, 360] by wraparound if needed
        (*) then change the new current speed to be speed + ∆a, keeping the speed between [0, 100] by cutoff if needed
    (*) resume scheduler co-routine by calling resume(scheduler)	
(*) end do
</pre>
   
<p>
<b>The function of a target co-routine is as follows:</b>
</p><pre class="code">
(*) call createTarget() function to create a new target with random coordinates on the game board
(*) switch to the co-routine of the "current" drone by calling resume(drone id) function
</pre>

<p>
<b>The function createTarget() is as follows:</b>
 </p><pre class="code">
(*) Generate a random x coordinate
(*) Generate a random y coordinate
</pre>

<p>
<b>The loop in the function of a scheduler co-routine is as follows:</b>
</p><p>
Note, the code below was modified to fix a minor inconsistency. This is not crucial,
as the results will not be auto-tested. This is a possible implementation of round-robin
scheduling of "active" drones, and the printing requirement.
</p><p>
</p><pre class="code">(*) start from i=0
(*)if drone (i%N)+1 is active
    (*) switch to the i’th drone co-routine
(*) if i%K == 0 //time to print the game board
    (*) switch to the printer co-routine
(*) if (i/N)%R == 0 &amp;&amp; i%N ==0 //R rounds have passed
    (*) find M - the lowest number of targets destroyed, between all of the active drones
    (*) "turn off" one of the drones that destroyed only M targets.
(*) i++
(*) if only one active drone is left
    (*)print The Winner is drone: &lt;id of the drone&gt;
    (*) stop the game (return to main() function or exit)
</pre>

<b>The function of a printer co-routine is as follows:</b>
<p>
</p><pre class="code">
(*) print the game board according to the format described below
(*) switch back to a scheduler co-routine
</pre>

<h2 id="command_line_arguments">Command line arguments</h2>
Note that the game border size is pre-defined to be 100 x 100.
<p>
Your program should get the following command-line arguments (written in ASCII as usual, every argument is 4 bytes in size):
</p><p>
</p><ul>
<li> N&lt;<i>int</i>&gt; – number of drones
</li><li> R&lt;<i>int</i>&gt; - number of full scheduler cycles between each elimination
</li><li> K&lt;<i>int</i>&gt; – how many drone steps between game board printings
</li><li> d&lt;<i>float</i>&gt; – maximum distance that allows to destroy a target
</li><li> seed&lt;<i>int</i>&gt; - seed for initialization of LFSR shift register
</li></ul>
<br>
<code class="code">&gt; ass3 &lt;N&gt; &lt;R&gt; &lt;K&gt; &lt;d&gt; &lt;seed&gt; </code>
<p>
For example:
<code class="code">&gt; ass3 5 8 10 30 15019 </code>
</p><p>
*<span style="font-size:85%">you can assume legal input</span>
</p><h2 id="initial_configuration_of_the_game">Initial configuration of the game </h2>
Initial configuration is calculated (pseudo)-randomly with 16 bit resolution (for each required number) before the game begins, by the main() function.
What this means is: generate a 16-bit pseudo-random integer by using the LFSR to generate 16 <b>new</b> pseudo-random bits (for each required number, shift the register 16 time,
computing a new radnom bit per shift),
and scale this pseudo-random number to fit the desired range. 
All coordinates should be inside the board (may be also on the board borders). Initial angle values are floating point in the range [0,360], but note that
you need to convert angles into radians if you want to use the SIN, COS, or SINCOS instructions (recommended). All other values are also float point numbers.
<p>
You should allocate a dynamic array of drones, which would contain drones’ current positions, speeds, headings, and scores. Every co-routine will be able to access this array for reading and writing. After reading the arguments and the file, you need to allocate space and initialize the co-routine structures. Two additional co-routines should be initialized: scheduler and printer.
</p><p>
<u>configuration order</u>
</p><ol>
<li> initialize the target
</li><li> initialize the drones
</li></ol>
* random coordinate generation order is : x coordinate, y coordinate (and for the drones the speed, and the angle is last)
<h2 id="how_to_print_the_game_board">How to print the game board</h2>
Each K drone steps the game board should be printed by printer co-routine.
All floating point numbers to be printed using %f or %lf with 2 digits after the decimal point, all angles to be printed in degrees (for readability).
Each printed line should end with a newline character.
The printing is in the following format:
<p>
</p><pre class="code">
x,y	                               ; this is the current target coordinates
1,x_1,y_1,α_1,speed_1,numOfDestroyedTargets_1    ; the first field is the drone id
2,x_2,y_2,α_2,speed_2,numOfDestroyedTargets_2    ; the fifth field is the number of targets destroyed by the drone
…
N,x_N,y_N,α_N,speed_N,numOfDestroyedTargets_N
</pre>

<h2 id="important_implementation_requirements">Important implementation requirements</h2>
<ul>
<li> A scheduler co-routine MUST be exclusively written in a separate file, the actual control transfer (context switch) should be done with the resume mechanism. Hence, label resume would be declared as extern to the scheduler, and register ebx would be used to transfer control.
</li><li> Different implementations (not ROUND ROBIN) of the scheduler will be optionally examined by the checkers
</li><li> Make all possible variables global in order not to pass them as arguments to your functions
</li></ul>
<h2 id="submission_instructions">Submission Instructions</h2>
You are to submit a single zip file containing ass3.s (file which contains main() function, common functions, and global variables), scheduler.s, printer.s, drone.s, and target.s files (no extra files are allowed). Your executable must be named ass3.
Make sure you follow the coding and submission instructions correctly.
<b>Submissions which deviate from these instructions will not be graded!</b>
<p>
<b><span style="font-size:120%">Good Luck!</span></b>

</p></div>


</div>

</div>
    
<div id="footer">
Page last modified on 11 June 2020,  13:10 by <b>shimony</b><br>
powered by <a href="course.html">CourseWiki 2.4.2</a>
, <a href="http://www.gzip.org/">gzip</a> supported
<br>
generated in 0.00051515 sec.
</div>

</body>
</html>
